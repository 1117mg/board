<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>íšŒì› ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/layout.css">
    <script>
        function confirmSubmit(event) {
            if (!confirm("ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                event.preventDefault();
            }
        }
        window.onload = function() {
            var form = document.getElementById("userForm");
            form.addEventListener("submit", confirmSubmit);

            // ì²´í¬ë°•ìŠ¤ì˜ ìƒíƒœê°€ ë³€ê²½ë  ë•Œ
            document.querySelectorAll('input[id^="read_"], input[id^="write_"], input[id^="download_"]').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    var parts = this.id.split('_');
                    var action = parts[0]; // read, write, download
                    var categoryId = parseInt(parts[1]); // ì¹´í…Œê³ ë¦¬ ID

                    // ë¶€ëª¨ ì¹´í…Œê³ ë¦¬ ì²´í¬ë°•ìŠ¤ê°€ ë³€ê²½ë  ë•Œ
                    if (this.dataset.parent === "true") {
                        var childCheckboxes = document.querySelectorAll('input[id^="' + action + '_"][data-parent-id="' + categoryId + '"]');
                        childCheckboxes.forEach(function(childCheckbox) {
                            childCheckbox.checked = checkbox.checked;
                        });
                    } else {
                        // ìì‹ ì¹´í…Œê³ ë¦¬ ì²´í¬ë°•ìŠ¤ê°€ ë³€ê²½ë  ë•Œ
                        var parentCheckbox = document.querySelector('input[id="' + action + '_' + checkbox.dataset.parentId + '"]');
                        if (parentCheckbox) {
                            if (!checkbox.checked) {
                                var allUnchecked = true;
                                document.querySelectorAll('input[id^="' + action + '_"][data-parent-id="' + checkbox.dataset.parentId + '"]').forEach(function(cb) {
                                    if (cb.checked) {
                                        allUnchecked = false;
                                    }
                                });
                                parentCheckbox.checked = !allUnchecked;
                            } else {
                                parentCheckbox.checked = true; // ìì‹ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ë©´ ë¶€ëª¨ ì²´í¬ë°•ìŠ¤ ì²´í¬
                            }
                        }
                    }
                });
            });
        }
        function checkAll(masterCheckbox, type) {
            var checkboxes = document.querySelectorAll('input[name^="' + type + '_"]');
            checkboxes.forEach(function (checkbox) {
                checkbox.checked = masterCheckbox.checked;
            });
        }
        document.querySelectorAll('label').forEach(function(label) {
            label.addEventListener('click', function() {
                checkAll(this);
            });
        });

        function oninputPhone(target) {
            target.value = target.value
                .replace(/[^0-9]/g, '')
                .replace(/(^02.{0}|^01.{1}|[0-9]{3,4})([0-9]{3,4})([0-9]{4})/g, "$1-$2-$3");
        }
    </script>
</head>
<body>
<header th:replace="thymeleaf/header :: header"></header>

<div class="content-area">
    <div class="py-5 text-center">
        <h1>íšŒì› ê´€ë¦¬</h1>
    </div>
    <form id="userForm" method="post" th:action="@{/admin/updateUser}" th:object="${user}">
        <input type="hidden" th:field="*{idx}" />
        <div class="py-5 text-center">
            <h4>íšŒì› ìƒì„¸ ì •ë³´</h4>
        </div>
        <table>
            <tr>
                <td>ì•„ì´ë””</td>
                <td><input type="text" name="userId" style="width: 95%;" th:value="*{userId}" readonly></td>
            </tr>
            <tr>
                <td>ë¹„ë°€ë²ˆí˜¸</td>
                <td th:text="${user.password}">ë¹„ë°€ë²ˆí˜¸</td>
            </tr>
            <tr>
                <td>ì´ë¦„</td>
                <td><input type="text" name="username" style="width: 95%;" th:value="*{username}"></td>
            </tr>
            <tr>
                <td>ê°€ì… ë‚ ì§œ</td>
                <td th:text="${user.regdate}">ê°€ì… ë‚ ì§œ</td>
            </tr>
            <tr>
                <td>ì „í™”ë²ˆí˜¸</td>
                <td><input type="text" name="phoneNo" oninput="oninputPhone(this)" style="width: 95%;" th:value="*{phoneNo}"></td>
            </tr>
        </table>
        <div class="py-5 text-center">
            <h4>ê¶Œí•œ ì„¤ì •</h4>
        </div>
        <table class="table table-bordered">
            <thead>
            <tr class="highlighted-row">
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>
                    <label>
                        <input type="checkbox" id="selectAllRead" onchange="checkAll(this, 'read')"> ì½ê¸° ì „ì²´ì„ íƒ
                    </label>
                </th>
                <th>
                    <label>
                        <input type="checkbox" id="selectAllWrite" onchange="checkAll(this, 'write')"> ì“°ê¸° ì „ì²´ì„ íƒ
                    </label>
                </th>
                <th>
                    <label>
                        <input type="checkbox" id="selectAllDownload" onchange="checkAll(this, 'download')"> íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì „ì²´ì„ íƒ
                    </label>
                </th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="category : ${categories}">
                <td th:class="${category.ctgPno == '0'} ? '' : 'child-category'">
                    <span th:class="${category.ctgPno == '0'} ? '' : 'child-category'">
                        <span th:if="${category.ctgPno != '0'}" th:text="'ğŸ‡± '"></span>
                        <span th:text="${category.ctgNm}"></span>
                    </span>
                </td>
                <td th:class="${category.ctgPno == '0'} ? '' : 'child-category'">
                    <label>
                        <input type="checkbox" th:id="'read_' + ${category.ctgNo}"
                               th:name="'read_' + ${category.ctgNo}"
                               th:checked="${authMap[category.ctgNo]?.canRead}"
                               th:data-parent="${category.ctgPno == '0'}"
                               th:data-parent-id="${category.ctgPno}" />
                        ì½ê¸°
                    </label>
                </td>
                <td th:class="${category.ctgPno == '0'} ? '' : 'child-category'">
                    <label>
                        <input type="checkbox" th:id="'write_' + ${category.ctgNo}"
                               th:name="'write_' + ${category.ctgNo}"
                               th:checked="${authMap[category.ctgNo]?.canWrite}"
                               th:data-parent="${category.ctgPno == '0'}"
                               th:data-parent-id="${category.ctgPno}" />
                        ì“°ê¸°
                    </label>
                </td>
                <td th:class="${category.ctgPno == '0'} ? '' : 'child-category'">
                    <label>
                        <input type="checkbox" th:id="'download_' + ${category.ctgNo}"
                               th:name="'download_' + ${category.ctgNo}"
                               th:checked="${authMap[category.ctgNo]?.canDownload}"
                               th:data-parent="${category.ctgPno == '0'}"
                               th:data-parent-id="${category.ctgPno}" />
                        íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    </label>
                </td>
            </tr>
            </tbody>
        </table>
        <div class="button-container row justify-content-center">
            <div class="col-md-4">
                <button type="submit" class="btn btn-info btn-block">ìˆ˜ì •</button>
            </div>
            <div class="col-md-4">
                <button type="button" onclick="history.back()" class="btn btn-secondary btn-block">ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
        <div class="button-container row justify-content-center">
            <div class="col-md-4">
                <a th:href="@{/admin/deleteUser/{id}(id=${user.idx})}" class="btn btn-warning btn-block">ì‚­ì œ</a>
            </div>
        </div>
    </form>
    <br>
</div>
</body>
</html>